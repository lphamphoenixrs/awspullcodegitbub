<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Site">
	<resultMap id="SiteMap"
		type="com.phoenixrs.api.entities.SiteEntity">
		<result property="id" column="id" />
		<result property="id_customer" column="id_customer" />
		<result property="id_country" column="id_country" />
		<result property="id_time_zone" column="id_time_zone" />
		<result property="name" column="name" />
		<result property="street" column="street" />
		<result property="lat" column="lat" />
		<result property="lng" column="lng" />
		<result property="built_since" column="built_since" />
		<result property="old_data" column="old_data" />
		<result property="number" column="number" />
		<result property="postal_code" column="postal_code" />
		<result property="city" column="city" />
		<result property="state" column="state" />
		<result property="commissioning" column="commissioning" />
		<result property="emergency_contact" column="emergency_contact" />
		<result property="ac_capacity" column="ac_capacity" />
		<result property="dc_capacity" column="dc_capacity" />
		<result property="status" column="status" />
		<result property="is_delete" column="is_delete" />
		<result property="created_date" column="created_date" />
		<result property="created_by" column="created_by" />
		<result property="updated_date" column="updated_date" />
		<result property="updated_by" column="updated_by" />
		<result property="address_short" column="address_short" />
		
		<result property="watts_3ph_total" column="watts_3ph_total" />
		<result property="sensor1_data" column="sensor1_data" />
		<result property="w_hours_total" column="w_hours_total" />
		<result property="today_kwh" column="today_kwh" />
		<result property="total_energy_this_month" column="total_energy_this_month" />
		<result property="eer_this_month" column="eer_this_month" />
		<result property="eer_last_month" column="eer_last_month" />
		<result property="w_hours_received" column="w_hours_received" />
		<result property="total_error" column="total_error" />
		<result property="alert_list" column="alert_list" />
		<result property="gallery" column="gallery" />
		<result property="id_site_type" column="id_site_type" />
		<result property="street_ws" column="street_ws" />
		<result property="localization_format" column="localization_format" />
		<result property="format_sql_short" column="format_sql_short" />
		<result property="format_sql_long" column="format_sql_long" />
		<result property="format_sql_string_short" column="format_sql_string_short" />
		<result property="format_sql_string_long" column="format_sql_string_long" />
		<result property="format_sql_string_mdy" column="format_sql_string_mdy" />
		<result property="offset_from" column="offset_from" />
		<result property="current_time" column="current_time" />
	</resultMap>
	
	
	<select id="getListEmployeeManageSite" resultType="Map" >
		SELECT
			s.id,
			s.id_customer,
			s.`name`,
			DATE_FORMAT(s.built_since,'%m/%d/%Y') AS built_since,
			DATE_FORMAT(s.commissioning,'%m/%d/%Y') AS commissioning,
			s.street,
			s.lat,
			s.lng,
			s.number,
			s.postal_code,
			s.city,
			s.state,
			s.`status`,
			s.is_delete,
			s.ac_capacity,
			s.dc_capacity,
			CONCAT_WS( ' ', c.first_name,c.last_name) AS customer_name,
			IF(t.is_manage,t.is_manage, 0) AS is_manage
		FROM
			site s
			LEFT JOIN customer c ON c.id = s.id_customer
			LEFT JOIN (
				SELECT si.id, 1 AS is_manage FROM site_employee_map se 
				LEFT JOIN site si ON si.id = se.id_site WHERE se.id_employee = #{id_customer}
			)t ON t.id = s.id
		WHERE s.is_delete = 0 AND s.status = 1
		<if test="keyword != null">
			AND s.name LIKE CONCAT("%",#{keyword}, "%")
		</if> 	
		    order by
	        <choose>  
	            <when test="sort_column == 'id'">
	                s.id ${order_by}
	            </when>         
	            <when test="sort_column == 'name'">
	                s.name ${order_by}
	            </when>
	            <when test="sort_column == 'customer_name'">
	                customer_name ${order_by}
	            </when>
	            
	            <otherwise>
			      s.id DESC
			    </otherwise>                                                  
	        </choose>  
		 	 
		 LIMIT ${limit} OFFSET ${offset};
	</select>
	
	<select id="getManageSiteTotalRecord"  resultType="int" parameterType="com.phoenixrs.api.entities.SiteEntity">
    	SELECT count(*) as totalRecord
		FROM site s  WHERE s.is_delete = 0 AND s.status = 1
		<if test="keyword != null">
			AND s.name LIKE CONCAT("%",#{keyword}, "%")
		</if>
  	</select>
  	
  	
  	
  	<select id="checkExitsManageSite"  resultType="int" parameterType="com.phoenixrs.api.entities.SiteEntity">
    	SELECT count(*) as totalRecord
		FROM site_employee_map s  WHERE s.id_employee = #{id_employee} AND s.id_site = #{id_site}
  	</select>
  	
  	
  	<insert id="insertSiteEmployeeMap" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `site_employee_map`(
			id_employee,
			id_site
		)VALUES(
			#{id_employee},
			#{id_site}
		);
		<selectKey keyProperty="id" resultType="int">
	        SELECT 
	        LAST_INSERT_ID() as id
        </selectKey>
	</insert>
  	
  	
  	
  	<delete id = "deleteSiteEmployeeMap" parameterType = "com.phoenixrs.api.entities.SiteEntity">
		DELETE from `site_employee_map` WHERE `id_employee` = #{id_employee} AND id_site = #{id_site};
	</delete>
  	
  	
  	<insert id="insertSite" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `site`(
			`id_customer`,
			`id_country`,
			`id_time_zone`,
			`name`,
			`street`,
			`lat`,
			`lng`,
			`built_since`,
			`old_data`,
			`number`,
			`postal_code`,
			`city`,
			`state`,
			`commissioning`,
			`emergency_contact`,
			`ac_capacity`,
			`dc_capacity`,
			`gallery`,
			`id_site_type`
		)VALUES(
			#{id_customer},
			#{id_country},
			#{id_time_zone},
			#{name},
			#{street},
			#{lat},
			#{lng},
			#{built_since},
			#{old_data},
			#{number},
			#{postal_code},
			#{state},
			#{city},
			#{commissioning},
			#{emergency_contact},
			#{ac_capacity},
			#{dc_capacity},
			#{gallery},
			#{id_site_type}
		);
		<selectKey keyProperty="id" resultType="int">
	        SELECT 
	        LAST_INSERT_ID() as id
        </selectKey>
	</insert>
	
	<update id="updateSite">
		UPDATE `site`
		SET
			`id_customer` = #{id_customer},
			`id_country` = #{id_country},
			`id_time_zone` = #{id_time_zone},
			`name` = #{name},
			`street` = #{street},
			`lat` = #{lat},
			`lng` = #{lng},
			`built_since` = #{built_since},
			`old_data` = #{old_data},
			`number` = #{number},
			`postal_code` = #{postal_code},
			`state` = #{state},
			`city` = #{city},
			`commissioning` = #{commissioning},
			`emergency_contact` = #{emergency_contact},
			`ac_capacity` = #{ac_capacity},
			`dc_capacity` = #{dc_capacity},
			`gallery` = #{gallery},
			`id_site_type` = #{id_site_type}
			
		WHERE
			`id` = #{id}
	</update>
  	
  	<select id="getList" resultType="Map" >
		SELECT
			s.id,
			s.id_customer,
			s.`name`,
			DATE_FORMAT(s.built_since,'%m/%d/%Y') AS built_since,
			DATE_FORMAT(s.commissioning,'%m/%d/%Y') AS commissioning,
			s.street,
			s.lat,
			s.lng,
			s.number,
			s.postal_code,
			s.city,
			s.state,
			s.`status`,
			s.is_delete,
			s.ac_capacity,
			s.dc_capacity,
			CONCAT_WS( ' ', c.first_name,c.last_name) AS customer_name,
			CONCAT_WS( ', ', s.number, s.street, s.city, s.state, s.postal_code ) AS address,
			s.site_default
		FROM
			site s
			LEFT JOIN customer c ON c.id = s.id_customer 
		<if test="keyword != null">
			WHERE (s.name LIKE CONCAT("%",#{keyword}, "%") or c.first_name LIKE CONCAT("%",#{keyword}, "%") or c.last_name LIKE CONCAT("%",#{keyword}, "%"))
		</if> 	
		    order by
	        <choose>  
	            <when test="sort_column == 'id'">
	                s.id ${order_by}
	            </when>         
	            <when test="sort_column == 'name'">
	                s.name ${order_by}
	            </when>
	            <when test="sort_column == 'customer_name'">
	                customer_name ${order_by}
	            </when>
	            
	            <otherwise>
			      s.id_customer DESC
			    </otherwise>                                                  
	        </choose>  
		 	 
		 LIMIT ${limit} OFFSET ${offset};
	</select>
	
  	
	
	<select id="getListCount"  resultType="int" parameterType="com.phoenixrs.api.entities.SiteEntity">
    	SELECT count(*) as totalRow
		FROM site s
		<if test="keyword != null">
			WHERE (s.name LIKE CONCAT("%",#{keyword}, "%") or c.first_name LIKE CONCAT("%",#{keyword}, "%") or c.last_name LIKE CONCAT("%",#{keyword}, "%"))
		</if> 
  	</select>
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	
  	

	<select id="getAllSiteByIdCustomer" resultMap="SiteMap" parameterType="String">
		SELECT
			s.id,
			s.id_customer,
			s.id_country,
			s.id_time_zone,
			s.`name`,
			s.street,
			s.lat,
			s.lng,
			built_since,
			s.old_data,
			s.number,
			s.postal_code,
			s.city,
			s.state,
			commissioning,
			s.emergency_contact,
			s.ac_capacity,
			s.dc_capacity,
			s.status,
			s.is_delete,
			s.created_date,
			s.created_by,
			s.updated_date,
			s.updated_by,
			s.gallery,
			s.id_site_type
		FROM
			site AS s
		WHERE
			s.id_customer = ${id_customer} AND s.is_delete = 0;
	</select>
	
	
	
  	
  	
  	<select id="getSiteCustomerById" resultMap="SiteMap" parameterType="Integer">
		SELECT
			COUNT( s.id ) AS total_site,
			ROUND(SUM( s.dc_capacity ),2) AS installed_capacity,
			SUM( t.expected_last_month ) AS expected_last_month,
			SUM( t.expected_this_month ) AS expected_this_month,
			ROUND(SUM( ivt.today_kwh ),0) AS measured_today,
			ms.w_hours_received,
			SUM( ms.w_hours_received - cFirstMonth.cfirst_month_w_hours_received ) AS measured_this_month,
			SUM( cFirstMonth.cfirst_month_w_hours_received - lFirstMonth.first_month_w_hours_received ) AS measured_last_month,
			ROUND( ( SUM( ms.w_hours_received - cFirstMonth.cfirst_month_w_hours_received ) / SUM( t.expected_this_month ) ) * 100, 2 ) AS err_this_month,
			ROUND( ( SUM( cFirstMonth.cfirst_month_w_hours_received - lFirstMonth.first_month_w_hours_received ) / SUM( t.expected_this_month ) ) * 100, 2 ) AS err_last_month,
			SUM( al.total_error ) AS total_error,
			DAY(LAST_DAY(NOW())) AS lday_off_month,
			ROUND(SUM( t.expected_this_month / DAY(LAST_DAY(NOW())) ), 0) AS expected_today,
			ROUND((SUM( ivt.today_kwh ) / SUM( t.expected_this_month / DAY(LAST_DAY(NOW())) )) * 100, 2) AS err_today,
			DATE_FORMAT(NOW(), '%M %d, %Y') AS today,
			DATE_FORMAT(NOW(), '%M 01, %Y') AS this_month,
			DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 MONTH), '%M 01, %Y') AS last_month
		FROM
			site s
			LEFT JOIN (
			SELECT
				en.id_site,
			CASE
					
					WHEN MONTH ( NOW( ) ) = 1 THEN
					en.`jan` 
					WHEN MONTH ( NOW( ) ) = 2 THEN
					en.`feb` 
					WHEN MONTH ( NOW( ) ) = 3 THEN
					en.`mar` 
					WHEN MONTH ( NOW( ) ) = 4 THEN
					en.`apr` 
					WHEN MONTH ( NOW( ) ) = 5 THEN
					en.`may` 
					WHEN MONTH ( NOW( ) ) = 6 THEN
					en.`jun` 
					WHEN MONTH ( NOW( ) ) = 7 THEN
					en.`jul` 
					WHEN MONTH ( NOW( ) ) = 8 THEN
					en.`aug` 
					WHEN MONTH ( NOW( ) ) = 9 THEN
					en.`sep` 
					WHEN MONTH ( NOW( ) ) = 10 THEN
					en.`oct` 
					WHEN MONTH ( NOW( ) ) = 11 THEN
					en.`nov` 
					WHEN MONTH ( NOW( ) ) = 12 THEN
					en.`dec` ELSE 0 
				END AS expected_this_month,
			CASE
					
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 1 THEN
					en.`jan` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 2 THEN
					en.`feb` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 3 THEN
					en.`mar` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 4 THEN
					en.`apr` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 5 THEN
					en.`may` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 6 THEN
					en.`jun` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 7 THEN
					en.`jul` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 8 THEN
					en.`aug` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 9 THEN
					en.`sep` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 10 THEN
					en.`oct` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 11 THEN
					en.`nov` 
					WHEN MONTH ( DATE_ADD( NOW( ), INTERVAL - 1 MONTH ) ) = 12 THEN
					en.`dec` ELSE 0 
				END AS expected_last_month 
			FROM
				energy_expectations en
				LEFT JOIN site et ON et.id = en.id_site 
			WHERE
				en.`year` = YEAR ( NOW( ) ) 
			) t ON t.id_site = s.id
			LEFT JOIN (
			SELECT
				sh.id_device,
				sh.w_hours_received,
				de.id_site 
			FROM
				model_shark100 AS sh,
				( SELECT id_device, MAX( time ) AS sh_time FROM model_shark100 ms GROUP BY id_device ) AS max_sh
				LEFT JOIN device AS de ON de.id = max_sh.id_device 
			WHERE
				sh.id_device = max_sh.id_device 
				AND sh.time = max_sh.sh_time 
			) ms ON s.id = ms.id_site
			LEFT JOIN (
			SELECT
				ms.time,
				ms.id_device,
				ms.today_kwh,
				dv.id_site 
			FROM
				model_ivt_solaron_ext ms,
				( SELECT id_device, MAX( time ) AS transaction_time FROM model_ivt_solaron_ext GROUP BY id_device ) AS max_ms
				LEFT JOIN device AS dv ON dv.id = max_ms.id_device 
			WHERE
				ms.id_device = max_ms.id_device 
				AND ms.time = max_ms.transaction_time 
			) ivt ON ivt.id_site = s.id
			LEFT JOIN (
			SELECT
				sh.time,
				sh.w_hours_received AS cfirst_month_w_hours_received,
				di.id_site 
			FROM
				model_shark100 sh,
				(
				SELECT
					sh.id_device,
					sh.w_hours_received,
					MIN( time ) AS sh_time 
				FROM
					model_shark100 AS sh 
				WHERE
					YEAR ( sh.time ) = YEAR ( NOW( ) ) 
					AND MONTH ( sh.time ) = MONTH ( NOW( ) ) 
				GROUP BY
					id_device 
				) AS max_first_month
				LEFT JOIN device AS di ON di.id = max_first_month.id_device 
			WHERE
				sh.id_device = max_first_month.id_device 
				AND sh.time = max_first_month.sh_time 
			) cFirstMonth ON cFirstMonth.id_site = s.id
			LEFT JOIN (
			SELECT
				sh.time,
				sh.w_hours_received AS first_month_w_hours_received,
				di.id_site 
			FROM
				model_shark100 sh,
				(
				SELECT
					sh.id_device,
					sh.w_hours_received,
					MIN( time ) AS sh_time 
				FROM
					model_shark100 AS sh 
				WHERE
					YEAR ( sh.time ) = YEAR ( ADDDATE( NOW( ), INTERVAL - 1 MONTH ) ) 
					AND MONTH ( sh.time ) = MONTH ( ADDDATE( NOW( ), INTERVAL - 1 MONTH ) ) 
				GROUP BY
					id_device 
				) AS max_first_month
				LEFT JOIN device AS di ON di.id = max_first_month.id_device 
			WHERE
				sh.id_device = max_first_month.id_device 
				AND sh.time = max_first_month.sh_time 
			) lFirstMonth ON lFirstMonth.id_site = s.id
			LEFT JOIN (
			SELECT
				s.id AS id_site,
				COUNT( a.id ) AS total_error 
			FROM
				site s
				LEFT JOIN device d ON d.id_site = s.id
				RIGHT JOIN alert a ON a.id_device = d.id 
				AND a.`status` = 1
				LEFT JOIN error er ON a.id_error = er.id 
			GROUP BY
				s.id 
			) al ON al.id_site = s.id 
		WHERE
			s.id_customer = #{id_customer}
		GROUP BY
			s.id_customer;
	</select>
	
	
	<select id="getDetailSite" resultType="com.phoenixrs.api.entities.SiteEntity" parameterType="com.phoenixrs.api.entities.SiteEntity">
		SELECT
			CONCAT_WS( ", ", s.city, s.state ) AS address_short,
			CONCAT_WS( ", ", s.number, s.street ) AS street_ws,
			s.id,
			s.id_customer,
			s.id_country,
			s.id_time_zone,
			s.`name`,
			s.lat,
			s.lng,
			s.old_data,
			s.number,
			s.street,
			s.postal_code,
			s.city,
			s.state,
			DATE_FORMAT( s.commissioning, '%m-%d-%Y' ) AS commissioning,
			s.emergency_contact,
			s.ac_capacity,
			s.dc_capacity,
			s.`status`,
			s.is_delete,
			s.created_date,
			s.created_by,
			s.updated_date,
			s.updated_by,
			DATE_FORMAT( s.built_since, '%m-%d-%Y' ) AS built_since,
			c.`name` AS country_name,
			s.gallery,
			s.id_site_type,
			c.localization_format,
			c.format_sql_short,
			c.format_sql_long,
			c.format_sql_string_short,
			c.format_sql_string_long,
			c.format_sql_string_mdy
		FROM
			site s 
			LEFT JOIN country c ON c.id = s.id_country
		WHERE
			s.id = #{id} 
			AND s.id_customer = #{id_customer} 
			AND s.`status` = 1 
			AND s.is_delete = 0
	</select>
	
	<select id="getActiveAlarm" resultType="Map" >
		SELECT
			a.id,
			a.id_device,
			a.id_level,
			a.id_error,
			a.start_date,
			a.end_date,
			a.asset,
			a.capacity,
			a.`status`,
			al.`name` AS alert_level,
			e.error_code,
			e.message,
			d.devicename,
			d.id_site,
			CASE
		
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 DAY ) THEN TIMESTAMPDIFF( DAY, a.start_date, NOW( ) )
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 HOUR ) THEN TIMESTAMPDIFF( HOUR, a.start_date, NOW( ) )
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 MINUTE ) THEN TIMESTAMPDIFF( MINUTE, a.start_date, NOW( ) ) ELSE 0
				END AS times_ago,
				
				CASE
		
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 DAY ) THEN 'day'
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 HOUR ) THEN 'hour'
				WHEN a.start_date <![CDATA[<]]> DATE_ADD( NOW( ), INTERVAL - 1 MINUTE ) THEN 'minute' ELSE 'now'
				END AS times_ago_unit
			
		FROM
			site s
			LEFT JOIN device d ON d.id_site = s.id
			RIGHT JOIN alert a ON a.id_device = d.id AND a.`status` = 1
			LEFT JOIN alert_level al ON al.id = a.id_level
			LEFT JOIN error e ON e.id = a.id_error 
		WHERE
			s.id = #{id}
			AND s.id_customer = #{id_customer}
			AND s.`status` = 1 
			AND s.is_delete = 0 LIMIT 6
	</select>
	
	
	<select id="getChartKPIDayIrradiance" resultType="Map" >
		SELECT
			s.id,
			s.id_time_zone,
			mr.id_device,
			DATE_FORMAT( mr.time, '%Y-%m-%d %H:%i:00' ) AS time,
			CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) AS local_time,
			DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%H:%i' ) AS time_day,
			mr.sensor1_data 
		FROM
			site s
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			LEFT JOIN device d ON d.id_site = s.id
			LEFT JOIN model_rt1_class30000 mr ON mr.id_device = d.id 
		WHERE
			s.id = #{id} 
			AND s.id_customer = #{id_customer}
			AND s.`status` = 1 
			AND s.is_delete = 0 
			AND YEAR ( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) = YEAR ( #{kpi_filter} ) 
			AND MONTH ( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) = MONTH ( #{kpi_filter} ) 
			AND DAY ( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) = DAY ( #{kpi_filter} )
	</select>
	
	
	<select id="getChartKPIDayPower" resultType="Map" >
		SELECT
			s.id,			
			DATE_FORMAT( mv.time, '%Y-%m-%d %H:%i:00' ) AS time,
			CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ) AS local_time,
			DATE_FORMAT( CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ), '%H:%i' ) AS time_day,
	
			mv.id_device,
			mv.ac_power
		FROM
			site s
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			LEFT JOIN device d ON d.id_site = s.id
			LEFT JOIN model_ivt_solaron_ext mv ON mv.id_device = d.id 
		WHERE
			s.id = #{id} 
			AND s.id_customer = #{id_customer}
			AND s.`status` = 1 
			AND s.is_delete = 0 
			AND YEAR ( CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ) ) = YEAR ( #{kpi_filter} ) 
			AND MONTH ( CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ) ) = MONTH ( #{kpi_filter} ) 
			AND DAY ( CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ) ) = DAY ( #{kpi_filter} )
	</select>
	
	
	<select id="getChartKPIDayEnergy" resultType="Map" >
		SELECT
			t.*
			FROM
				(
					SELECT
						s.id,
						DATE_FORMAT( mv.time, '%Y-%m-%d %H' ) AS time,
						DATE_FORMAT(CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d %H') AS local_time,
						mv.id_device,
					mv.ytd_kwh_total 
					FROM
						site s
						LEFT JOIN time_zone t ON t.id = s.id_time_zone
						LEFT JOIN device d ON d.id_site = s.id
						LEFT JOIN model_ivt_solaron_ext mv ON mv.id_device = d.id 
					WHERE
						s.id = #{id} 
						AND s.id_customer = #{id_customer} 
						AND s.`status` = 1 
						AND s.is_delete = 0 
						AND CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ) BETWEEN #{kpi_filter} 
						AND  ADDDATE( #{kpi_filter} ,INTERVAL 1 DAY) 
					) t GROUP BY t.local_time
	</select>
	
	
	
	<select id="getChartKPIMonthPower" resultType="Map" >
		SELECT
			t.*,
			ROUND(SUM(t.ac_power),2)  AS total_month_ac_power
		FROM
			(
			SELECT
				s.id,
				DATE_FORMAT( mv.time, '%Y-%m-%d %H:%i:00' ) AS `utc_time`,
				CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ) AS local_time,
				DATE_FORMAT( CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ), '%d. %b' ) AS convert_time,
				DATE_FORMAT( CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ), '%W, %b %d, %Y' ) AS full_time,
				mv.id_device,
				mv.ac_power 
			FROM
				site s
				LEFT JOIN time_zone t ON t.id = s.id_time_zone
				LEFT JOIN device d ON d.id_site = s.id
				LEFT JOIN model_ivt_solaron_ext mv ON mv.id_device = d.id 
			WHERE
				s.id = #{id}
				AND s.id_customer = #{id_customer}
				AND s.`status` = 1 
				AND s.is_delete = 0 
				AND mv.time IS NOT NULL
				AND YEAR ( CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ) ) = YEAR ( #{kpi_filter} ) 
				AND MONTH ( CONVERT_TZ( mv.time, t.`offset`, #{offset_timezone} ) ) = MONTH ( #{kpi_filter} )
			) t 
		GROUP BY
			t.convert_time 
	</select>
	
	
	<select id="getChartKPIMonthInsolation" resultType="Map" >
		SELECT t.*, ROUND(AVG(t.sensor1_data) * 24/1000 ,2)  AS avg_month_sensor1_data FROM (
			SELECT
					s.id,
					s.id_time_zone,
					mr.id_device,
					DATE_FORMAT( mr.time, '%Y-%m-%d %H:%i:00' ) AS `utc_time`,
					CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%H:%i' ) AS time_day,
					DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%d. %b' ) AS convert_time,
					DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%W, %b %d, %Y' ) AS full_time,
					mr.sensor1_data 
				FROM
					site s
					LEFT JOIN time_zone t ON t.id = s.id_time_zone
					LEFT JOIN device d ON d.id_site = s.id
					LEFT JOIN model_rt1_class30000 mr ON mr.id_device = d.id 
				WHERE
					s.id = #{id} 
					AND s.id_customer = #{id_customer}
					AND s.`status` = 1 
					AND s.is_delete = 0 
					AND mr.time IS NOT NULL
					AND YEAR ( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) = YEAR ( #{kpi_filter} ) 
					AND MONTH ( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) = MONTH ( #{kpi_filter} ) 
		)t GROUP BY t.convert_time
	</select>
	
	<select id="getChartKPIMonth" resultType="Map" >
		SELECT
			tmin.*,
			m.full_time,
			m.convert_time,
			MIN( tmin.ytd_kwh_total ) AS min_value,
			MAX( tmin.ytd_kwh_total ) AS max_value,
			ROUND(MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2) AS total_day_kw,
			m.avg_month_sensor1_data,
			IFNULL(ROUND( ((MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total )) / (m.avg_month_sensor1_data * tmin.ac_capacity)) * 100 ,2),0) AS day_pr
		FROM
			(
			SELECT
				iv.time,
				si.id,
				si.ac_capacity,
				iv.id_device,
				iv.ytd_kwh_total,
				DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d' ) AS local_time
				
			FROM
				site si
				LEFT JOIN time_zone t ON t.id = si.id_time_zone
				LEFT JOIN device d ON d.id_site = si.id
				LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
			WHERE
				si.id = #{id}
				AND si.id_customer = #{id_customer}
				AND si.`status` = 1 
				AND si.is_delete = 0 
				AND iv.error = 0
				AND YEAR ( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ) ) = YEAR ( #{kpi_filter} ) 
				AND MONTH ( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ) ) = MONTH ( #{kpi_filter} ) 
				
			) tmin 
			LEFT JOIN (
				SELECT t.*, ROUND((AVG(t.sensor1_data) * 24)/1000 ,2)  AS avg_month_sensor1_data FROM (
						SELECT
								s.id,
								s.id_time_zone,
								mr.id_device,
								DATE_FORMAT( mr.time, '%Y-%m-%d %H:%i:00' ) AS `utc_time`,
								CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) AS local_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%H:%i' ) AS time_day,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%d. %b' ) AS convert_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%W, %b %d, %Y' ) AS full_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d' ) AS mr_local_time,
								mr.sensor1_data 
							FROM
								site s
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
								LEFT JOIN device d ON d.id_site = s.id
								LEFT JOIN model_rt1_class30000 mr ON mr.id_device = d.id 
							WHERE
								s.id = #{id}
								AND s.id_customer = #{id_customer}
								AND s.`status` = 1 
								AND s.is_delete = 0 
								AND mr.time IS NOT NULL
								AND YEAR ( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) = YEAR ( #{kpi_filter} ) 
								AND MONTH ( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) = MONTH ( #{kpi_filter} ) 
					)t GROUP BY t.convert_time
			)m ON m.mr_local_time = tmin.local_time
		GROUP BY tmin.local_time
	</select>
	
	
	<select id="getChartKPIYear" resultType="Map" >
		SELECT
			tmin.*,
			m.full_time,
			m.convert_time,
			MIN( tmin.ytd_kwh_total ) AS min_value,
			MAX( tmin.ytd_kwh_total ) AS max_value,
			ROUND(MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2) AS total_month_kw,
			m.avg_month_sensor1_data,
			IFNULL(ROUND( ((MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total )) / (m.avg_month_sensor1_data * tmin.ac_capacity)) * 100 ,2),0) AS month_pr
		FROM
			(
			SELECT
				iv.time,
				si.id,
				si.ac_capacity,
				iv.id_device,
				iv.ytd_kwh_total,
				DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%Y-%m' ) AS local_time
				
			FROM
				site si
				LEFT JOIN time_zone t ON t.id = si.id_time_zone
				LEFT JOIN device d ON d.id_site = si.id
				LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
			WHERE
				si.id = #{id}
				AND si.id_customer = #{id_customer}
				AND si.`status` = 1 
				AND si.is_delete = 0 
				AND iv.error = 0
				AND YEAR ( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ) ) = YEAR ( #{kpi_filter} ) 
				
			) tmin 
			LEFT JOIN (
				SELECT t.*, ROUND((AVG(t.sensor1_data) * 24 * ((DAY(MAX(t.local_time)) + 1) - DAY(MIN(t.local_time))) )/1000 ,2)  AS avg_month_sensor1_data  FROM (
						SELECT
								s.id,
								s.id_time_zone,
								mr.id_device,
								DATE_FORMAT( mr.time, '%Y-%m-%d %H:%i:00' ) AS `utc_time`,
								CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) AS local_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%H:%i' ) AS time_day,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), "%b '%y" ) AS convert_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%W, %b %d, %Y' ) AS full_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y-%m' ) AS mr_local_time,
								mr.sensor1_data 
							FROM
								site s
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
								LEFT JOIN device d ON d.id_site = s.id
								LEFT JOIN model_rt1_class30000 mr ON mr.id_device = d.id 
							WHERE
								s.id = #{id}
								AND s.id_customer = #{id_customer}
								AND s.`status` = 1 
								AND s.is_delete = 0 
								AND mr.time IS NOT NULL
								AND YEAR ( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) = YEAR ( #{kpi_filter} ) 
					)t GROUP BY t.mr_local_time
			)m ON m.mr_local_time = tmin.local_time
		GROUP BY tmin.local_time
	</select>
	
	
	<update id="updateSite">
		UPDATE `site`
		SET
			`commissioning` = #{commissioning},
			`built_since` = #{built_since},
			`gallery` = #{gallery},
			`emergency_contact` = #{emergency_contact},
			`dc_capacity` = #{dc_capacity},
			`ac_capacity` = #{ac_capacity},
			`old_data` = #{old_data},
			`lat` = #{lat},
			`lng` = #{lng},
			`id_time_zone` = #{id_time_zone},
			`id_country` = #{id_country},
			`street` = #{street},
			`number` = #{number},
			`postal_code` = #{postal_code},
			`city` = #{city},
			`state` = #{state}
		WHERE
			`id` = #{id} AND `id_customer` = #{id_customer}
	</update>
	
	
	
	<select id="reportQuickQuery" resultType="Map" >
		SELECT
			d.devicename,
			DATE_FORMAT( CONVERT_TZ( sh.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d %H:%i' ) AS local_time,
			DATE_FORMAT( CONVERT_TZ( sh.time, t.`offset`, #{offset_timezone} ), '%H:%i' ) AS local_hour,
			sh.* 
		FROM
			site s
			LEFT JOIN time_zone t ON t.id = s.id_time_zone
			LEFT JOIN device d ON d.id_site = s.id
			<if test="device_type == 1">
			LEFT JOIN model_ivt_solaron_ext sh ON d.id = sh.id_device
			</if>
			
			<if test="device_type == 2">
			LEFT JOIN model_shark100 sh ON d.id = sh.id_device
			</if>
			
			<if test="device_type == 4">
			LEFT JOIN model_rt1_class30000 sh ON d.id = sh.id_device
			</if>
			 
		WHERE
			d.id = #{id_device} 
			AND s.id = #{id} 
			AND s.id_customer = #{id_customer}
			AND s.`status` = 1 
			AND s.is_delete = 0 
			AND CONVERT_TZ( sh.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} 
			AND #{end_date}
	</select>

	
	
	<select id="getSpecificYieldMonth" resultType="Map" >
		SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_day_kw,
				CONCAT_WS( ' - ', DATE_FORMAT( k.t_min, #{format_sql_string_mdy} ), DATE_FORMAT( k.t_max, #{format_sql_string_mdy} ) ) AS xAxisTitle 
			FROM
				(
				SELECT
					si.id,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d' ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), #{format_sql_string_short} ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%d. %b' ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id}
					AND si.id_customer = #{id_customer}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
					FROM
						(
						SELECT
							s.id,
							s.id_customer,
							s.id_time_zone,
							mr.id_device,
							DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%d. %b' ) AS convert_time,
							DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d' ) AS mr_local_time,
							MIN( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) AS t_min,
							MAX( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) AS t_max 
						FROM
							site s
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
							LEFT JOIN device d ON d.id_site = s.id
							LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
						WHERE
							s.id = #{id}
							AND s.id_customer = #{id_customer}
							AND s.`status` = 1 
							AND s.is_delete = 0 
							AND mr.time IS NOT NULL 
							AND CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} AND #{end_date}
						) t 
					GROUP BY
						t.convert_time 
					) k ON k.id = tmin.id 

			GROUP BY
				tmin.local_time;
	</select>
	
	<select id="getSpecificYieldYear" resultType="Map" >
		SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_month_kw,
				CONCAT_WS( ' - ', DATE_FORMAT( k.t_min, #{format_sql_string_mdy} ), DATE_FORMAT( k.t_max, #{format_sql_string_mdy} ) ) AS xAxisTitle 
			FROM
				(
				SELECT
					si.id,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%Y-%m' ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), #{format_sql_string_short} ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%b %Y' ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id}
					AND si.id_customer = #{id_customer}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
					FROM
						(
						SELECT
							s.id,
							s.id_customer,
							s.id_time_zone,
							mr.id_device,
							DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%d. %b' ) AS convert_time,
							DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y-%m' ) AS mr_local_time,
							MIN( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) AS t_min,
							MAX( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) AS t_max 
						FROM
							site s
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
							LEFT JOIN device d ON d.id_site = s.id
							LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
						WHERE
							s.id = #{id}
							AND s.id_customer = #{id_customer}
							AND s.`status` = 1 
							AND s.is_delete = 0 
							AND mr.time IS NOT NULL 
							AND CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} AND #{end_date}
						) t 
					GROUP BY
						t.convert_time 
					) k ON k.id = tmin.id 

			GROUP BY
				tmin.local_time;
	</select>
	
	
	<select id="getDailyReportSumary" resultType="Map" >
		SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_today_kw,
				k.month_ytd_kwh_total,
				k.month_format_time,
				m.year_ytd_kwh_total,
				m.year_format_time
			FROM
				(
				SELECT
					si.id,
					d.devicename,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), #{format_sql_short} ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), #{format_sql_string_short} ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), #{format_sql_string_mdy} ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id}
					AND si.id_customer = #{id_customer}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
						FROM
							(
							SELECT
								s.id,
								ROUND(MAX(mr.ytd_kwh_total) - MIN(mr.ytd_kwh_total),2) AS month_ytd_kwh_total,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y-%m' ) AS local_format_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%M %Y' ) AS month_format_time
							FROM
								site s
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
								LEFT JOIN device d ON d.id_site = s.id
								LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
							WHERE
								s.id = #{id}
								AND s.id_customer = #{id_customer}
								AND s.`status` = 1 
								AND s.is_delete = 0 
								AND mr.error = 0
								AND CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) BETWEEN CONCAT_WS('-',YEAR(#{start_date}), MONTH(#{start_date}), '01 00:00:00') AND #{end_date}
							) t 
						GROUP BY t.local_format_time
					) k ON k.id = tmin.id 
					
				LEFT JOIN (
					SELECT
						t.* 
						FROM
							(
							SELECT
								s.id,
								ROUND(MAX(mr.ytd_kwh_total) - MIN(mr.ytd_kwh_total),2) AS year_ytd_kwh_total,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y' ) AS local_format_time,
								DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y' ) AS year_format_time
							FROM
								site s
								LEFT JOIN time_zone t ON t.id = s.id_time_zone
								LEFT JOIN device d ON d.id_site = s.id
								LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
							WHERE
								s.id = #{id}
								AND s.id_customer = #{id_customer}
								AND s.`status` = 1 
								AND s.is_delete = 0 
								AND mr.error = 0
								AND CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) BETWEEN CONCAT_WS('-',YEAR(#{start_date}), '01-01 00:00:00') AND #{end_date}
							) t 
						GROUP BY t.local_format_time 	
				) m ON m.id = tmin.id 
			GROUP BY
				tmin.local_time;
	</select>
	
	
	<select id="getDailyReportChart" resultType="Map" >
	
		<if test="kpi_type == 'daily_report'">
			SELECT
				si.id,
				si.id_customer,
				iv.time,
				iv.ytd_kwh_total,
				CONCAT_WS('',DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), REPLACE(#{format_sql_long}, ":%i:%s", "")),':00') AS local_time,
				DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%H:00' ) AS convert_time,
				DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), #{format_sql_string_short} ) AS full_time
			FROM
				site si
				LEFT JOIN time_zone t ON t.id = si.id_time_zone
				LEFT JOIN device d ON d.id_site = si.id
				LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
			WHERE
				si.id = #{id} 
				AND si.id_customer = #{id_customer}
				AND si.`status` = 1 
				AND si.is_delete = 0 
				AND iv.error = 0 
				AND CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} 
				AND #{end_date} 
			GROUP BY
				local_time;
		</if>
		
		<if test="kpi_type == 'monthly_report'">
			SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_month_kw,
				CONCAT_WS( ' - ', DATE_FORMAT( k.t_min, #{format_sql_string_mdy} ), DATE_FORMAT( k.t_max, #{format_sql_string_mdy} ) ) AS xAxisTitle 
			FROM
				(
				SELECT
					si.id,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d' ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%W, %b %d, %Y' ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%d. %b' ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id}
					AND si.id_customer = #{id_customer}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
					FROM
						(
						SELECT
							s.id,
							s.id_customer,
							s.id_time_zone,
							mr.id_device,
							DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%d. %b' ) AS convert_time,
							DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d' ) AS mr_local_time,
							MIN( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) AS t_min,
							MAX( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) AS t_max 
						FROM
							site s
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
							LEFT JOIN device d ON d.id_site = s.id
							LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
						WHERE
							s.id = #{id}
							AND s.id_customer = #{id_customer}
							AND s.`status` = 1 
							AND s.is_delete = 0 
							AND mr.time IS NOT NULL 
							AND CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} AND #{end_date}
						) t 
					GROUP BY
						t.convert_time 
					) k ON k.id = tmin.id 

			GROUP BY
				tmin.local_time;
		</if>
		
	</select>
	
	
	<select id="getReportVisualizationDevice" resultType="Map" >
		SELECT
				tmin.*,
				ROUND( MAX( tmin.ytd_kwh_total ) - MIN( tmin.ytd_kwh_total ), 2 ) AS energy_month_kw,
				CONCAT_WS( ' - ', DATE_FORMAT( k.t_min, #{format_sql_string_mdy} ), DATE_FORMAT( k.t_max, #{format_sql_string_mdy} ) ) AS xAxisTitle 
			FROM
				(
				SELECT
					si.id,
					si.id_customer,
					iv.time,
					iv.ytd_kwh_total,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%Y-%m' ) AS local_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%b %Y' ) AS full_time,
					DATE_FORMAT( CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ), '%b %Y' ) AS convert_time
				FROM
					site si
					LEFT JOIN time_zone t ON t.id = si.id_time_zone
					LEFT JOIN device d ON d.id_site = si.id
					LEFT JOIN model_ivt_solaron_ext iv ON iv.id_device = d.id 
				WHERE
					si.id = #{id_site}
					AND si.id_customer = #{id_customer}
					AND d.id = #{id_device}
					AND si.`status` = 1 
					AND si.is_delete = 0 
					AND iv.error = 0 
					AND CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} AND #{end_date}
				) tmin
				
				LEFT JOIN (
					SELECT
						t.* 
					FROM
						(
						SELECT
							s.id,
							s.id_customer,
							s.id_time_zone,
							mr.id_device,
							DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%d. %b' ) AS convert_time,
							DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y-%m' ) AS mr_local_time,
							MIN( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) AS t_min,
							MAX( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) ) AS t_max 
						FROM
							site s
							LEFT JOIN time_zone t ON t.id = s.id_time_zone
							LEFT JOIN device d ON d.id_site = s.id
							LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
						WHERE
							s.id = #{id_site}
							AND s.id_customer = #{id_customer}
							AND d.id = #{id_device}
							AND s.`status` = 1 
							AND s.is_delete = 0 
							AND mr.time IS NOT NULL 
							AND CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} AND #{end_date}
						) t 
					GROUP BY
						t.convert_time 
					) k ON k.id = tmin.id 

			GROUP BY
				tmin.local_time;
	</select>
	
	<select id="getReportVisualizationDeviceDay" resultType="Map" >
		SELECT
			t.*,
			ROUND( MAX( t.ytd_kwh_total ) - MIN( t.ytd_kwh_total ), 2 ) AS hour_kwh_total,
			CONCAT_WS('',DATE_FORMAT( t.convert_time, REPLACE(#{format_sql_long}, ":%i:%s", "") ),':00') AS tooltip_date,
			DATE_FORMAT( t.convert_time, '%H:00' ) AS hour_time,
			DATE_FORMAT( t.convert_time, #{format_sql_string_short} ) AS xAxisTitle 
		FROM
			(
			SELECT
				s.id,
				mr.ac_power,
				mr.ytd_kwh_total,
				DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d %H:%s:%i' ) AS convert_time,
				DATE_FORMAT( CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ), '%Y-%m-%d %H' ) AS mr_local_time 
			FROM
				site s
				LEFT JOIN time_zone t ON t.id = s.id_time_zone
				LEFT JOIN device d ON d.id_site = s.id
				LEFT JOIN model_ivt_solaron_ext mr ON mr.id_device = d.id 
			WHERE
				s.id = #{id_site}
				AND s.id_customer = #{id_customer}
				AND d.id = #{id_device}
				AND s.`status` = 1 
				AND s.is_delete = 0 
				AND mr.time IS NOT NULL 
				AND CONVERT_TZ( mr.time, t.`offset`, #{offset_timezone} ) BETWEEN #{start_date} 
				AND #{end_date} 
			) t 
		GROUP BY
			HOUR ( t.mr_local_time );
	</select>
	
	<select id="getAnnualComparison" resultType="Map" >
		SELECT t.*,
			(
			IFNULL(t.jan_kwh_total, 0) + IFNULL(t.feb_kwh_total, 0) + IFNULL(t.mar_kwh_total, 0) + IFNULL(t.apr_kwh_total, 0) + IFNULL(t.may_kwh_total, 0) + IFNULL(t.jun_kwh_total, 0) + IFNULL(t.jul_kwh_total, 0) + IFNULL(t.aug_kwh_total, 0) + IFNULL(t.sep_kwh_total, 0) + IFNULL(t.oct_kwh_total, 0) + IFNULL(t.nov_kwh_total, 0) + IFNULL(t.dec_kwh_total, 0)
			) AS year_total
			
			FROM (
				SELECT
					s.id,
					iv.time,
					iv.id_device,
					YEAR(iv.time) AS `year`,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=1 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=1 then iv.ytd_kwh_total end),0))/1000, 2 ) AS jan_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=2 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=2 then iv.ytd_kwh_total end),0))/1000, 2 ) AS feb_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=3 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=3 then iv.ytd_kwh_total end),0))/1000, 2 ) AS mar_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=4 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=4 then iv.ytd_kwh_total end),0))/1000, 2 ) AS apr_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=5 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=5 then iv.ytd_kwh_total end),0))/1000, 2 ) AS may_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=6 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=6 then iv.ytd_kwh_total end),0))/1000, 2 ) AS jun_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=7 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=7 then iv.ytd_kwh_total end),0))/1000, 2 ) AS jul_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=8 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=8 then iv.ytd_kwh_total end),0))/1000, 2 ) AS aug_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=9 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=9 then iv.ytd_kwh_total end),0))/1000, 2 ) AS sep_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=10 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=10 then iv.ytd_kwh_total end),0))/1000, 2 ) AS oct_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=11 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=11 then iv.ytd_kwh_total end),0))/1000, 2 ) AS nov_kwh_total,
					ROUND((IFNULL(MAX(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=12 then iv.ytd_kwh_total end) - MIN(case when MONTH(CONVERT_TZ( iv.time, t.`offset`, #{offset_timezone}))=12 then iv.ytd_kwh_total end),0))/1000, 2 ) AS dec_kwh_total
					
				FROM
					site s 
					LEFT JOIN time_zone t ON t.id = s.id_time_zone
					LEFT JOIN device d ON d.id_site = s.id
					LEFT JOIN model_ivt_solaron_ext iv ON d.id = iv.id_device
					WHERE s.id = #{id_site} AND s.id_customer = #{id_customer} AND iv.error = 0 AND iv.ytd_kwh_total > 0 AND CONVERT_TZ( iv.time, t.`offset`, '+07:00') <![CDATA[<=]]> #{current_time}
					GROUP BY iv.id_device, YEAR(iv.time)
			)t GROUP BY t.id_device, YEAR(t.time)
	</select>
	
	
</mapper>